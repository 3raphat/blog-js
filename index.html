<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog Feed Page</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400..700;1,400..700&family=Source+Sans+3:ital,wght@0,200..900;1,200..900&display=swap"
      rel="stylesheet"
    />

    <!-- tailwindcss -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Source Sans 3", "sans-serif"],
              serif: ["Lora", "serif"],
            },
          },
        },
      }
    </script>
    <style type="text/tailwindcss">
      @layer base {
        body {
          @apply font-sans;
        }
      }
    </style>

    <!-- daisyui -->
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@4.10.2/dist/full.min.css"
      rel="stylesheet"
      type="text/css"
    />

    <script type="module">
      import { getAllPostsByName } from "./js/blog/getPost.mjs"
      import { deletePostById } from "./js/blog/deletePost.mjs"
      import { debounce, formatDistanceToNow } from "./js/utils.mjs"

      const feed = document.getElementById("feed")
      const search = document.getElementById("search")
      const statusText = document.getElementById("status-text")

      const name = window.localStorage.getItem("name")
      if (name) {
        document.getElementById(
          "show-my-name"
        ).textContent = `My name is: ${name}`
      }

      async function handleInput() {
        const author = search.value

        if (author === "") {
          feed.innerHTML = ""
          statusText.textContent = ""
          return
        }

        statusText.textContent = `Fetching posts for ${search.value}...`

        const posts = await getAllPostsByName(author)

        if (posts.length === 0) {
          feed.innerHTML = ""
          statusText.textContent = `No posts found for ${author}`
          return
        }

        feed.innerHTML = posts
          .map(
            (post) => `
              <article class="card card-side border border-neutral">
                <div class="card-body p-6">
                  <div class="flex items-center text-sm">
                    <img src=${
                      post.author.avatar.url
                    } class="mr-2 rounded-full size-6" />
                    ${post.author.name}
                    <span class="text-accent">
                      &nbsp;Â· ${
                        new Date(post.created) < new Date(post.updated)
                          ? `Updated ${formatDistanceToNow(post.updated)}`
                          : formatDistanceToNow(post.created)
                      }
                    </span>
                  </div>
                    <a href="/post/index.html?id=${post.id}&author=${
              post.author.name
            }">
                    <h2 class="card-title line-clamp-1">
                      ${post.title}
                      </h2>
                    <p class="font-serif line-clamp-3">${post.body}</p>
                  </a>
                  ${
                    post.author.name === window.localStorage.getItem("name")
                      ? `
                        <div class="card-actions items-center ${
                          post.tags.length === 0
                            ? "justify-end"
                            : "justify-between"
                        }">
                          ${
                            post.tags.length === 0
                              ? ""
                              : `
                                <div class="flex gap-1 justify-start">
                                  ${post.tags
                                    .map(
                                      (tag) =>
                                        `<span class="badge badge-neutral">${tag}</span>`
                                    )
                                    .join("")}
                                </div>`
                          }
                          <div class="dropdown">
                            <div tabindex="0" role="button" class="btn btn-sm btn-circle">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                <path d="M3 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM8.5 10a1.5 1.5 0 1 1 3 0 1.5 1.5 0 0 1-3 0ZM15.5 8.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3Z" />
                              </svg>
                            </div>
                            <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                              <li>
                                <a class="" href="/post/edit.html?id=${
                                  post.id
                                }">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                    <path d="m5.433 13.917 1.262-3.155A4 4 0 0 1 7.58 9.42l6.92-6.918a2.121 2.121 0 0 1 3 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 0 1-.65-.65Z" />
                                    <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0 0 10 3H4.75A2.75 2.75 0 0 0 2 5.75v9.5A2.75 2.75 0 0 0 4.75 18h9.5A2.75 2.75 0 0 0 17 15.25V10a.75.75 0 0 0-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5Z" />
                                  </svg>
                                  Edit
                                </a>
                              </li>
                              <li>
                                <button id="delete-button" data-post-id="${
                                  post.id
                                }">
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 0 0 6 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 1 0 .23 1.482l.149-.022.841 10.518A2.75 2.75 0 0 0 7.596 19h4.807a2.75 2.75 0 0 0 2.742-2.53l.841-10.52.149.023a.75.75 0 0 0 .23-1.482A41.03 41.03 0 0 0 14 4.193V3.75A2.75 2.75 0 0 0 11.25 1h-2.5ZM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4ZM8.58 7.72a.75.75 0 0 0-1.5.06l.3 7.5a.75.75 0 1 0 1.5-.06l-.3-7.5Zm4.34.06a.75.75 0 1 0-1.5-.06l-.3 7.5a.75.75 0 1 0 1.5.06l.3-7.5Z" clip-rule="evenodd" />
                                  </svg>
                                  Delete
                                </button>
                              </li>
                            </ul>
                          </div>
                        </div>
                      `
                      : ""
                  }
                </div>
                ${
                  post.media?.url
                    ? `
                        <figure class="max-w-[196px] min-w-[196px] aspect-square">
                          <img src=${post.media.url} class="object-cover w-full h-full" />
                        </figure>
                      `
                    : ""
                }
              </article>
            `
          )
          .join("")

        statusText.textContent = `Fetched ${posts.length} posts for ${author}`

        const deleteButtons = document.querySelectorAll("#delete-button")

        deleteButtons.forEach((button) => {
          button.addEventListener("click", async () => {
            const postId = button.getAttribute("data-post-id")
            try {
              await deletePostById(postId)
              alert("Post deleted successfully")
              window.location.reload()
            } catch (error) {
              console.error(error)
            }
          })
        })
      }

      const debouncedHandleInput = debounce(handleInput, 500)

      search.addEventListener("input", debouncedHandleInput)
    </script>
  </head>
  <body>
    <div class="container mx-auto">
      <h1 class="text-7xl font-bold">Blog Feed Page</h1>
      <nav class="navbar">
        <a class="btn btn-ghost btn-sm btn-active" href="index.html">
          Blog Feed
        </a>
        <a class="btn btn-ghost btn-sm" href="/post/index.html">Create Blog</a>
        <a class="btn btn-ghost btn-sm" href="/post/edit.html">Edit Blog</a>
        <a class="btn btn-ghost btn-sm" href="/account/register.html">
          Register
        </a>
        <a class="btn btn-ghost btn-sm" href="/account/login.html">Login</a>
      </nav>
      <div>
        <div class="flex items-end gap-2">
          <input
            type="text"
            id="search"
            name="search"
            placeholder="Search by author name"
            class="input input-bordered"
          />
          <div class="flex flex-col">
            <p class="text-sm text-secondary" id="show-my-name"></p>
            <p class="text-sm text-accent" id="status-text"></p>
          </div>
        </div>
        <section class="grid grid-cols-1 gap-4 mt-4" id="feed"></section>
      </div>
    </div>
  </body>
</html>
